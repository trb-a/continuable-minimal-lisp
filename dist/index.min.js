/*!
  ContinuableMinimalLisp.js v0.4.4
  https://github.com/trb-a/continuable-minimal-lisp
  Released under the MIT License.
  Note: Language specification's license is unconfirmed.
*/
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function r(n,e,r){return n(r={path:e,exports:{},require:function(n,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&r.path)}},r.exports),r.exports}function t(n){if(n.__esModule)return n;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(n).forEach((function(r){var t=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(e,r,t.get?t:{enumerable:!0,get:function(){return n[r]}})})),e}var a=Object.freeze({__proto__:null,default:["do",["def","new",["fn",["a","&","b"],[".","Reflect",["`","construct"],"a","b"]]],["def","del",["fn",["a","b"],[".","Reflect",["`","deleteProperty"],"a","b"]]],["def","list",["fn",["&","a"],"a"]],["def",">=",["fn",["a","b"],["if",["<","a","b"],!1,!0]]],["def",">",["fn",["a","b"],["if",[">=","a","b"],["if",["=","a","b"],!1,!0],!1]]],["def","<=",["fn",["a","b"],["if",[">","a","b"],!1,!0]]],["def","classOf",["fn",["a"],[".",[".-",[".-","Object",["`","prototype"]],["`","toString"]],["`","call"],"a"]]],["def","not",["fn",["a"],["if","a",!1,!0]]],["def","null?",["fn",["a"],["=",null,"a"]]],["def","true?",["fn",["a"],["=",!0,"a"]]],["def","false?",["fn",["a"],["=",!1,"a"]]],["def","string?",["fn",["a"],["if",["=","a",null],!1,["=",["`","String"],[".-",[".-","a",["`","constructor"]],["`","name"]]]]]],["def","pr-str",["fn",["&","a"],[".",["map",[".-","JSON",["`","stringify"]],"a"],["`","join"],["`"," "]]]],["def","str",["fn",["&","a"],[".",["map",["fn",["x"],["if",["string?","x"],"x",[".","JSON",["`","stringify"],"x"]]],"a"],["`","join"],["`",""]]]],["def","prn",["fn",["&","a"],["do",[".","console",["`","log"],[".",["map",[".-","JSON",["`","stringify"]],"a"],["`","join"],["`"," "]]],null]]],["def","println",["fn",["&","a"],["do",[".","console",["`","log"],[".",["map",["fn",["x"],["if",["string?","x"],"x",[".","JSON",["`","stringify"],"x"]]],"a"],["`","join"],["`"," "]]],null]]],["def","list?",["fn",["a"],[".","Array",["`","isArray"],"a"]]],["def","contains?",["fn",["a","b"],[".","a",["`","hasOwnProperty"],"b"]]],["def","get",["fn",["a","b"],["if",["contains?","a","b"],[".-","a","b"],null]]],["def","set",["fn",["a","b","c"],["do",[".-","a","b","c"],"a"]]],["def","keys",["fn",["a"],[".","Object",["`","keys"],"a"]]],["def","vals",["fn",["a"],[".","Object",["`","values"],"a"]]],["def","cons",["fn",["a","b"],[".",["`",[]],["`","concat"],["list","a"],"b"]]],["def","concat",["fn",["&","a"],[".",[".-",["list"],["`","concat"]],["`","apply"],["list"],"a"]]],["def","nth","get"],["def","first",["fn",["a"],["if",[">",[".-","a",["`","length"]],0],["nth","a",0],null]]],["def","last",["fn",["a"],["nth","a",["-",[".-","a",["`","length"]],1]]]],["def","count",["fn",["a"],[".-","a",["`","length"]]]],["def","empty?",["fn",["a"],["if",["list?","a"],["=",0,[".-","a",["`","length"]]],["=","a",null]]]],["def","slice",["fn",["a","b","&","end"],[".","a",["`","slice"],"b",["if",[">",[".-","end",["`","length"]],0],["get","end",0],[".-","a",["`","length"]]]]]],["def","rest",["fn",["a"],["slice","a",1]]],["def","and",["~",["fn",["&","xs"],["if",["empty?","xs"],!0,["if",["=",1,[".-","xs",["`","length"]]],["first","xs"],["list",["`","let"],["list",["`","__and"],["first","xs"]],["list",["`","if"],["`","__and"],["concat",["`",["and"]],["rest","xs"]],["`","__and"]]]]]]]],["def","or",["~",["fn",["&","xs"],["if",["empty?","xs"],null,["if",["=",1,[".-","xs",["`","length"]]],["first","xs"],["list",["`","let"],["list",["`","__or"],["first","xs"]],["list",["`","if"],["`","__or"],["`","__or"],["concat",["`",["or"]],["rest","xs"]]]]]]]]],null]}),i=function(n,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,e){n.__proto__=e}||function(n,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r])})(n,e)};var o=function(){return(o=Object.assign||function(n){for(var e,r=1,t=arguments.length;r<t;r++)for(var a in e=arguments[r])Object.prototype.hasOwnProperty.call(e,a)&&(n[a]=e[a]);return n}).apply(this,arguments)};var u=Object.create?function(n,e,r,t){void 0===t&&(t=r),Object.defineProperty(n,t,{enumerable:!0,get:function(){return e[r]}})}:function(n,e,r,t){void 0===t&&(t=r),n[t]=e[r]};function l(n){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&n[e],t=0;if(r)return r.call(n);if(n&&"number"==typeof n.length)return{next:function(){return n&&t>=n.length&&(n=void 0),{value:n&&n[t++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function f(n,e){var r="function"==typeof Symbol&&n[Symbol.iterator];if(!r)return n;var t,a,i=r.call(n),o=[];try{for(;(void 0===e||e-- >0)&&!(t=i.next()).done;)o.push(t.value)}catch(n){a={error:n}}finally{try{t&&!t.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o}function s(n){return this instanceof s?(this.v=n,this):new s(n)}var c=Object.create?function(n,e){Object.defineProperty(n,"default",{enumerable:!0,value:e})}:function(n,e){n.default=e};var v=t(Object.freeze({__proto__:null,__extends:function(n,e){function r(){this.constructor=n}i(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},get __assign(){return o},__rest:function(n,e){var r={};for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&e.indexOf(t)<0&&(r[t]=n[t]);if(null!=n&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(t=Object.getOwnPropertySymbols(n);a<t.length;a++)e.indexOf(t[a])<0&&Object.prototype.propertyIsEnumerable.call(n,t[a])&&(r[t[a]]=n[t[a]])}return r},__decorate:function(n,e,r,t){var a,i=arguments.length,o=i<3?e:null===t?t=Object.getOwnPropertyDescriptor(e,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(n,e,r,t);else for(var u=n.length-1;u>=0;u--)(a=n[u])&&(o=(i<3?a(o):i>3?a(e,r,o):a(e,r))||o);return i>3&&o&&Object.defineProperty(e,r,o),o},__param:function(n,e){return function(r,t){e(r,t,n)}},__metadata:function(n,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(n,e)},__awaiter:function(n,e,r,t){return new(r||(r=Promise))((function(a,i){function o(n){try{l(t.next(n))}catch(n){i(n)}}function u(n){try{l(t.throw(n))}catch(n){i(n)}}function l(n){var e;n.done?a(n.value):(e=n.value,e instanceof r?e:new r((function(n){n(e)}))).then(o,u)}l((t=t.apply(n,e||[])).next())}))},__generator:function(n,e){var r,t,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,t&&(a=2&i[0]?t.return:i[0]?t.throw||((a=t.return)&&a.call(t),0):t.next)&&!(a=a.call(t,i[1])).done)return a;switch(t=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,t=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(n,o)}catch(n){i=[6,n],t=0}finally{r=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},__createBinding:u,__exportStar:function(n,e){for(var r in n)"default"===r||Object.prototype.hasOwnProperty.call(e,r)||u(e,n,r)},__values:l,__read:f,__spread:function(){for(var n=[],e=0;e<arguments.length;e++)n=n.concat(f(arguments[e]));return n},__spreadArrays:function(){for(var n=0,e=0,r=arguments.length;e<r;e++)n+=arguments[e].length;var t=Array(n),a=0;for(e=0;e<r;e++)for(var i=arguments[e],o=0,u=i.length;o<u;o++,a++)t[a]=i[o];return t},__await:s,__asyncGenerator:function(n,e,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,a=r.apply(n,e||[]),i=[];return t={},o("next"),o("throw"),o("return"),t[Symbol.asyncIterator]=function(){return this},t;function o(n){a[n]&&(t[n]=function(e){return new Promise((function(r,t){i.push([n,e,r,t])>1||u(n,e)}))})}function u(n,e){try{(r=a[n](e)).value instanceof s?Promise.resolve(r.value.v).then(l,f):c(i[0][2],r)}catch(n){c(i[0][3],n)}var r}function l(n){u("next",n)}function f(n){u("throw",n)}function c(n,e){n(e),i.shift(),i.length&&u(i[0][0],i[0][1])}},__asyncDelegator:function(n){var e,r;return e={},t("next"),t("throw",(function(n){throw n})),t("return"),e[Symbol.iterator]=function(){return this},e;function t(t,a){e[t]=n[t]?function(e){return(r=!r)?{value:s(n[t](e)),done:"return"===t}:a?a(e):e}:a}},__asyncValues:function(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,r=n[Symbol.asyncIterator];return r?r.call(n):(n=l(n),e={},t("next"),t("throw"),t("return"),e[Symbol.asyncIterator]=function(){return this},e);function t(r){e[r]=n[r]&&function(e){return new Promise((function(t,a){(function(n,e,r,t){Promise.resolve(t).then((function(e){n({value:e,done:r})}),e)})(t,a,(e=n[r](e)).done,e.value)}))}}},__makeTemplateObject:function(n,e){return Object.defineProperty?Object.defineProperty(n,"raw",{value:e}):n.raw=e,n},__importStar:function(n){if(n&&n.__esModule)return n;var e={};if(null!=n)for(var r in n)"default"!==r&&Object.prototype.hasOwnProperty.call(n,r)&&u(e,n,r);return c(e,n),e},__importDefault:function(n){return n&&n.__esModule?n:{default:n}},__classPrivateFieldGet:function(n,e){if(!e.has(n))throw new TypeError("attempted to get private field on non-instance");return e.get(n)},__classPrivateFieldSet:function(n,e,r){if(!e.has(n))throw new TypeError("attempted to set private field on non-instance");return e.set(n,r),r}})),d=t(a),p=(r((function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.TheGlobal=r.ContinuablePromise=r.EnvWrapper=r.Interpreter=r.findEnv=r.setEnv=r.newEnv=r.isContinuation=r.isApplicable=r.isHalfMacro=r.isMacro=r.isLambda=r.isEnv=r.isBOR=r.isPromiseLike=r.cloneAST=r.VERSION=r.LANGUAGE=void 0,r.LANGUAGE="Continuable-miniMAL-Lisp",r.VERSION="0.4.4",r.cloneAST=function(n,e){if(void 0===e&&(e=new Map),e.has(n))return e.get(n);if("object"==typeof n&&null!==n&&n.constructor===Object)return Object.keys(n).reduce((function(t,a){return t[a]=r.cloneAST(n[a],e),t}),{});if(n instanceof Array){var t=e.set(n,[]).get(n);return t.push.apply(t,n.map((function(n){return r.cloneAST(n,e)}))),t}return n};var t=function(n){throw n};r.isPromiseLike=function(n){return!!n&&("object"==typeof n||"function"==typeof n)&&"function"==typeof n.then};var a=function(n){return"string"==typeof n||t(n+" is not a symbol")},i=function(n){return"string"==typeof n||"symbol"==typeof n||"number"==typeof n||t("String(x) is not a property index")};r.isBOR=function(n,e){return"object"==typeof e&&null!==e&&"string"==typeof e.bor&&e.constructor===Object&&1===Object.keys(e).length&&e.bor in n};var o=function(n){return n instanceof Array},u=function(n){return o(n)||t(n+" is not an array")};r.isEnv=function(n){return n instanceof Array&&"object"==typeof n[0]&&null!==n[0]&&(n[1]instanceof Array||null===n[1])},r.isLambda=function(n){return n instanceof Array&&"=>"===n[0]&&4===n.length&&r.isEnv(n[3])&&n[1]instanceof Array&&n[1].every((function(n){return"string"==typeof n}))},r.isMacro=function(n){return n instanceof Array&&"~"===n[0]&&2===n.length&&r.isApplicable(n[1])},r.isHalfMacro=function(n){return n instanceof Array&&"~~"===n[0]&&2===n.length&&r.isApplicable(n[1])};var l=function(n){return"function"==typeof n};r.isApplicable=function(n){return r.isLambda(n)||l(n)||r.isContinuation(n)||r.isMacro(n)||r.isHalfMacro(n)};var f=function(n){return r.isApplicable(n)||t(n+" is not a applicable")},s=function(n){return r.isHalfMacro(n)||t(n+" is not a half macro")};r.isContinuation=function(n){return"object"==typeof n&&null!==n&&function(n){return"object"==typeof n&&null!==n&&n.parent instanceof Array&&"number"==typeof n.index&&r.isEnv(n.env)&&(null===n.flag||"string"==typeof n.flag)&&"object"==typeof n.handler}(n.current)&&n.stack instanceof Array&&"string"==typeof n.version&&n.version.replace(/\.[^.]+$/,"")===r.VERSION.replace(/\.[^.]+$/,"")};var c=function(n){return r.isContinuation(n)||t(n+" is not a continuation")},p=function(n){return n instanceof Array&&"try"===n[0]&&n[2]instanceof Array&&"string"==typeof n[2][1]&&n[2].length>=3||t(n+" is not a try form or malformed")};r.newEnv=function(n,e,r,t){void 0===t&&(t=!0);for(var a={},i=0;i<e.length;i++){if(t&&"&"===e[i]){a[""+e[i+1]]=r.slice(i);break}a[""+e[i]]=r[i]}return[a,n]},r.setEnv=function(n,e,r){return n[0][""+e]=r},r.findEnv=function(n,e,r){for(var t=n;t;t=t[1]){if(t[0].hasOwnProperty(r))return[t[0][r],!0,!1];if(!t[1]&&e&&r in e&&null!==e[r]&&("object"==typeof e[r]||"function"==typeof e[r]))return[{bor:r},!0,!0]}return[null,!1,!1]};var y=function(n){return n[1]?y(n[1]):n},h=function(n){var e,a=this;if(this.stackMax=1/0,this.base=x,this.env=[{},null],this.dynamicEnv=[{},null],this.loadCore=!0,this.debugCount=0,this.debugMode=!1,this.debugCore=!1,this.debugMax=1/0,this.debugFilter=function(){return!0},this.debug=function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];if(a.debugMode&&a.debugFilter(n)&&(e=e.map((function(n){return n instanceof Array?r.cloneAST(n):n})),console.log.apply(console,v.__spreadArrays([n],e)),a.debugCount++,a.debugCount>a.debugMax))throw new Error("too many debug message!")},this.evalAST=function(n,e,i){void 0===e&&(e=a.env),void 0===i&&(i=a.dynamicEnv);for(var u=[n],l=[{parent:u,index:0,env:e,dynamicEnv:i,flag:null,handler:null}],f=function(n){return l.length>=a.stackMax?t("Stack overflow"):(l.push(n),n)},s=function(){a.debug("Current eval-stack length, eval-stack: ",l.length,l);var n=l.pop(),e=n.parent,i=n.index,u=n.env,s=n.dynamicEnv,c=n.flag,d=n.handler,y=e[i];a.debug("Next evaluating AST node, env, dynamicEnv, flag: ",y,u,s,c);try{if("string"==typeof y){var h=r.findEnv(u,a.base,y),w=h[0],x=h[1];e[i]=x?w:t(y+" not found")}else if(o(y)){var O="string"==typeof y[0]?a.derefBOR(r.findEnv(u,a.base,y[0])[0]):null,j=(r.isMacro(O)?b:r.isHalfMacro(O)||r.isHalfMacro(a.derefBOR(y[0]))&&c?m:"string"==typeof y[0]&&E.hasOwnProperty(y[0])?E[y[0]]:r.isContinuation(y[0])||r.isContinuation(O)?_:g)({node:y,env:u,base:a.base,dynamicEnv:s,flag:c,handler:d,cont:{current:n,stack:l,lang:r.LANGUAGE,version:r.VERSION,info:null},interpreter:a}),S=j.ret,R=j.subevals,C=j.reevals;null==C||C.reverse().forEach((function(n){var r,t,a,o,l,c;return f({parent:null!==(r=n.parent)&&void 0!==r?r:e,index:null!==(t=n.index)&&void 0!==t?t:i,env:null!==(a=n.env)&&void 0!==a?a:u,dynamicEnv:null!==(o=n.dynamicEnv)&&void 0!==o?o:s,flag:null!==(l=n.flag)&&void 0!==l?l:null,handler:null!==(c=n.handler)&&void 0!==c?c:d})})),null==R||R.reverse().forEach((function(n){var r,t,a,o,l,c;return n&&f({parent:null!==(r=n.parent)&&void 0!==r?r:e,index:null!==(t=n.index)&&void 0!==t?t:i,env:null!==(a=n.env)&&void 0!==a?a:u,dynamicEnv:null!==(o=n.dynamicEnv)&&void 0!==o?o:s,flag:null!==(l=n.flag)&&void 0!==l?l:null,handler:null!==(c=n.handler)&&void 0!==c?c:d})})),e[i]=S}}catch(n){if(r.isContinuation(n))throw a.debug("Suspend. Continuation: ",n),n;if(n instanceof A)throw a.debug("Suspend. ContinuablePomise: ",n),n;if(a.debug("Caught an exception. Exception: ",n),!d)throw n;var P=d.parent[d.index];p(P);var M=P[2][1];r.setEnv(d.env,M,n),l.splice.apply(l,v.__spreadArrays([0,l.length],l.filter((function(n){return n.handler!==d})))),f(d)}finally{a.debug("Evaluation Done. Node, env, dynamicEnv: ",e[i],u,s)}};l.length;)s();return a.debug("Evaluatin finished. Result: ",u[0]),u[0]},this.eval=function(n){return a.evalAST(n)},this.rep=function(n){try{return JSON.stringify(a.eval(JSON.parse(n)))}catch(n){if(n instanceof TypeError&&n.message.match(/(circular|cyclic)/i))return;throw n}},this.resume=function(n,e){return a.evalAST(["resume",n,e])},this.evalInBase=function(n){a.evalAST(n,[a.base,null])},this.derefBOR=function(n){return r.isBOR(a.base,n)?a.base[n.bor]:n},this.wrapLambda=function(n){return r.isLambda(n)?function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return a.evalAST(v.__spreadArrays([["`",n]],e))}:n},this.evalAsync=function(n){return new Promise((function(e,r){var t=function(n){try{e(n instanceof A?n.resume():a.eval(n))}catch(n){n instanceof A?n.then((function(){return t(n)}),(function(n){return r(n)})):r(n)}};t(n)}))},"object"==typeof(e=n)&&null!==e&&Object.keys(e).filter((function(n){return void 0===e[n]})).forEach((function(n){return delete e[n]})),Object.assign(this,n),this.loadCore){var i=this.debugMode;this.debugMode=this.debugCore,this.evalInBase(d),this.debugMode=i}};r.Interpreter=h;var g=function(n){var e=n.node,t=n.env,a=n.dynamicEnv,i=n.base,o=n.flag,u=n.interpreter,f=u.derefBOR(e[0]);if(!o&&!r.isApplicable(f)){var s=v.__spreadArrays(e);return{ret:s,reevals:[{flag:"!"}],subevals:s.map((function(n,e){return{parent:s,index:e,env:t}}))}}var c=e.slice(1);if(l(f))try{return{ret:f.apply(void 0,c.map((function(n){return u.wrapLambda(u.derefBOR(n))})))}}catch(y){if(r.isContinuation(y))throw"Javascript function can not throw any continuation.";throw y}else{if(!r.isLambda(f))throw String(f)+" is not applicable";var d=f[1],p=f[2],y=f[3];if("function"!=typeof p)return{ret:p,reevals:[{env:r.newEnv(y,d,c)}]};try{return{ret:p(new w(r.newEnv(y,d,c),a,t,i),u)}}catch(y){if(r.isContinuation(y))throw"Javascript function can not throw any continuation.";throw y}}},b=function(n){var e=n.node,i=n.env,o=n.base,u=n.interpreter;a(e[0]);var l,f=u.derefBOR(r.findEnv(i,o,e[0])[0]);return l=f,r.isMacro(l)||t(l+" is not a macro"),{ret:v.__spreadArrays([f[1]],e.slice(1)),reevals:[{flag:"!"},{flag:null}]}},m=function(n){var e=n.node,t=n.env,i=n.base,o=n.flag,u=n.interpreter;if(o){l=u.derefBOR(e[0]);return s(l),{ret:v.__spreadArrays([l[1]],e.slice(1)),reevals:[{flag:"!"},{flag:null}]}}a(e[0]);var l=u.derefBOR(r.findEnv(t,i,e[0])[0]);s(l);var f=v.__spreadArrays(e);return{ret:f,subevals:f.map((function(n,e){return{parent:f,index:e}})),reevals:[{flag:"!"}]}},_=function(n){var e,t=n.node,a=n.flag,i=n.cont,o=t[0];if(a||r.isApplicable(o)){var u=t.slice(1);c(o);var l=o.current,f=l.parent;f[l.index]=null!==(e=u[0])&&void 0!==e?e:null;var s=o.stack.length>0?o.stack[0].parent:f;if(1!==s.length)throw"Illeal root of continuation";var d=o.stack.map((function(n){return n.parent===s&&(n.parent=i.current.parent,n.index=i.current.index),n}));return{ret:s[0],subevals:d.reverse()}}var p=v.__spreadArrays(t);return{ret:p,reevals:[{flag:"!"}],subevals:p.map((function(n,e){return{parent:p,index:e}}))}},E={"`":function(n){return{ret:n.node[1]}},eval:function(n){var e=n.node;if(n.flag)return{ret:e[1],reevals:[{flag:null}]};var r=v.__spreadArrays(e);return{ret:r,reevals:[{flag:"!"}],subevals:[{parent:r,index:1}]}},def:function(n){var e=n.node,t=n.env;if(n.flag){var i=e[1],o=e[2],u=void 0===o?null:o;return a(i),{ret:r.setEnv(t,i,u)}}var l=v.__spreadArrays(e);return{ret:l,reevals:[{flag:"!"}],subevals:[{parent:l,index:2}]}},defdynamic:function(n){var e=n.node,t=n.dynamicEnv;if(n.flag){var i=e[1],o=e[2],u=void 0===o?null:o;return a(i),r.setEnv(y(t),i,u),{ret:u}}var l=v.__spreadArrays(e);return{ret:l,reevals:[{flag:"!"}],subevals:[{parent:l,index:2}]}},"~":function(n){var e=n.node,r=n.flag,t=v.__spreadArrays(e);return r?(f(t[1]),{ret:t}):{ret:t,reevals:[{flag:"!"}],subevals:[{parent:t,index:1}]}},"~~":function(n){var e=n.node,r=n.flag,t=v.__spreadArrays(e);return r?(f(t[1]),{ret:t}):{ret:t,reevals:[{flag:"!"}],subevals:[{parent:t,index:1}]}},".-":function(n){var e=n.node,r=(n.base,n.flag),t=n.interpreter;if(r){var a=t.derefBOR(e[1]);if(null==a)throw"Can't read/set property of null or undefined.";var o=e.map((function(n){return t.derefBOR(n)})),u=o[2],l=o[3];return i(u),{ret:3===e.length?a[u]:a[u]=l}}var f=v.__spreadArrays(e);return{ret:f,reevals:[{flag:"!"}],subevals:f.map((function(n,e){return e>=1&&{parent:f,index:e}}))}},".":function(n){var e=n.node,t=(n.base,n.flag),a=n.interpreter;if(!t){var o=v.__spreadArrays(e);return{ret:o,reevals:[{flag:"!"}],subevals:o.map((function(n,e){return e>=1&&{parent:o,index:e}}))}}var u=a.derefBOR(e[1]);if(null==u)throw"Can't call method of null or undefined.";var l=e[2],s=e.slice(3);if(i(l),"function"!=typeof u[l])return f(u[l]),{ret:v.__spreadArrays([u[l]],s),reevals:[{flag:"!"}]};try{return{ret:u[l].apply(u,s.map((function(n){return a.wrapLambda(a.derefBOR(n))})))}}catch(n){if(r.isContinuation(n))throw"Javascript methods can not throw any continuation.";throw n}},oget:function(n){var e=n.node,r=(n.base,n.flag),t=n.interpreter;if(r){var a=t.derefBOR(e[1]);if(null==a)throw"Can't read property of null or undefined.";var o=e[2];return i(o),{ret:a[o]}}var u=v.__spreadArrays(e);return{ret:u,reevals:[{flag:"!"}],subevals:u.map((function(n,e){return e>=1&&{parent:u,index:e}}))}},oset:function(n){var e=n.node,r=(n.base,n.flag),t=n.interpreter;if(r){var a=t.derefBOR(e[1]);if(null==a)throw"Can't set property of null or undefined.";var o=e[2],u=e[3];return i(o),{ret:a[o]=u}}var l=v.__spreadArrays(e);return{ret:l,reevals:[{flag:"!"}],subevals:l.map((function(n,e){return e>=1&&{parent:l,index:e}}))}},try:function(n){var e=n.node,t=n.env,a=n.dynamicEnv,i=n.flag,o=n.cont,u=n.handler;if(p(e),i){if("!"===i)return{ret:e[1]};if("!!"===i)return{ret:e[2][2],reevals:[{}]};throw"Illegal status for try-catch."}var l={parent:o.current.parent,index:o.current.index,env:r.newEnv(t,[],[]),dynamicEnv:a,flag:"!!",handler:u},f=v.__spreadArrays(e);return{ret:f,reevals:[{flag:"!",handler:l}],subevals:[{parent:f,index:1,handler:l}]}},fn:function(n){var e,r=n.node,a=n.env;return(e=r)instanceof Array&&"fn"===e[0]&&3===e.length&&e[1]instanceof Array&&e[1].every((function(n){return"string"==typeof n}))||t(e+" is not a fn form or malformed"),{ret:["=>",r[1],r[2],a]}},map:function(n){var e=n.node;if(n.flag){var r=e[1],t=e[2];u(t);var a=t.map((function(n,e){return[r,t[e]]}));return{ret:a,subevals:a.map((function(n,e){return{parent:a,index:e,flag:"!"}}))}}var i=v.__spreadArrays(e);return{ret:i,reevals:[{flag:"!"}],subevals:i.map((function(n,e){return e>=1&&{parent:i,index:e}}))}},apply:function(n){var e=n.node;if(n.flag){var r=e[1],t=e.slice(2),a=t.pop();return u(a),t.push.apply(t,a),{ret:v.__spreadArrays([r],t),reevals:[{flag:"!"}]}}var i=v.__spreadArrays(e);return{ret:i,reevals:[{flag:"!"}],subevals:i.map((function(n,e){return e>=1&&{parent:i,index:e}}))}},let:function(n){var e,a=n.node,i=n.env;(e=a)instanceof Array&&"let"===e[0]&&e[1]instanceof Array&&e.length>=3||t(e+" is not a let form or malformed");var o=a[1],u=a[2];o.length%2==1&&o.push(null);var l=o.reduce((function(n,e,r){return r%2?n:n.concat([[o[r],o[r+1]]])}),[]);return{ret:v.__spreadArrays(["do"],l.map((function(n){return["def",n[0],n[1]]})),[u]),reevals:[{env:r.newEnv(i,[],[])}]}},"dynamic-let":function(n){var e,a=n.node,i=n.dynamicEnv,o=n.flag;if((e=a)instanceof Array&&"dynamic-let"===e[0]&&e[1]instanceof Array&&e.length>=3||t(e+" is not a let form or malformed"),o){var u=a[1];d=a[2];u.length%2==1&&u.push(null);var l=u.reduce((function(n,e,r){return r%2?n:n.concat([[u[r],u[r+1]]])}),[]),f=r.newEnv(i,[],[]);return l.forEach((function(n){var e=n[0],t=n[1];return r.setEnv(f,String(e),t)})),{ret:d,reevals:[{dynamicEnv:f}]}}var s=a[0],c=a[1],d=a[2],p=v.__spreadArrays(c);return{ret:[s,p,d],subevals:p.map((function(n,e){return e})).filter((function(n){return n%2==1})).map((function(n){return{parent:p,index:n}})),reevals:[{flag:"!"}]}},do:function(n){var e=n.node.slice(1),r=e.slice(-1)[0];return{ret:void 0===r?null:r,reevals:[{flag:null}],subevals:e.slice(0,-1).map((function(n){return{parent:[n],index:0}}))}},if:function(n){var e=n.node;if(n.flag)return{ret:e[1]?e[2]:e[3],reevals:[{flag:null}]};var r=v.__spreadArrays(e);return{ret:r,reevals:[{flag:"!"}],subevals:[{parent:r,index:1}]}},suspend:function(n){var e,r=n.node,t=n.flag,a=n.cont;if(t){var i=r.slice(1);throw a.info=null!==(e=i[0])&&void 0!==e?e:null,a}var o=v.__spreadArrays(r);return{ret:o,reevals:[{flag:"!"}],subevals:[{parent:o,index:1}]}},resume:function(n){var e=n.node,r=(n.flag,e[1]),t=e.slice(2);return c(r),{ret:v.__spreadArrays([r],t),reevals:[{flag:"!"}]}},dynamic:function(n){var e=n.node,i=n.dynamicEnv,o=e[1];a(o);var u=r.findEnv(i,null,o),l=u[0];return{ret:u[1]?l:t("dynamic variable "+o+" not found")}},await:function(n){var e=n.node,r=n.flag,t=n.cont,a=n.interpreter;if(r){var i=e.slice(1);throw new A(a,0===i.length?null:1===i.length?i[0]:Promise.all(i),t)}var o=v.__spreadArrays(e);return{ret:o,reevals:[{flag:"!"}],subevals:[{parent:o,index:1}]}}},w=function(n,e,t,a){var i=this;this.get=function(n){return r.findEnv(i.env,i.base,n)[0]},this.has=function(n){return r.findEnv(i.env,i.base,n)[1]},this.set=function(n,e){return r.setEnv(i.env,n,e)},this.dynamicGet=function(n){return r.findEnv(i.dynamicEnv,null,n)[0]},this.dynamicHas=function(n){return r.findEnv(i.dynamicEnv,null,n)[1]},this.dynamicSet=function(n,e){return r.setEnv(y(i.dynamicEnv),n,e)},this.dynamicSetLocal=function(n,e){return r.setEnv(i.dynamicEnv,n,e)},this.callerGet=function(n){return r.findEnv(i.callerEnv,i.base,n)[0]},this.callerHas=function(n){return r.findEnv(i.callerEnv,i.base,n)[1]},this.env=n,this.dynamicEnv=e,this.callerEnv=t,this.base=a};r.EnvWrapper=w;var A=function(){function n(n,e,t){var a=this;this.status="pending",this.promise=new Promise((function(n,e){a.resolve=n,a.reject=e})),this.interpreter=n,this.coninuation=t,r.isPromiseLike(e)?e.then((function(n){a.resolvedValue=n,a.status="fulfilled",a.resolve()}),(function(n){a.rejectedReason=n,a.status="rejected",a.reject(n)})):(this.resolvedValue=e,this.status="fulfilled",this.resolve())}return n.prototype.isFulfilled=function(){return"fulfilled"===this.status},n.prototype.isRejected=function(){return"rejected"===this.status},n.prototype.isPending=function(){return"pending"===this.status},n.prototype.reason=function(){if(!this.isRejected())throw new Error("The promise is not rejected yet.");return this.rejectedReason},n.prototype.resume=function(){if(!this.isFulfilled())throw new Error("The promise is not fulfilled yet.");return this.interpreter.resume(this.coninuation,this.resolvedValue)},n.prototype.then=function(n,e){return this.promise.then(n,e)},n.prototype.catch=function(n){return this.promise.catch(n)},n}();r.ContinuablePromise=A,r.TheGlobal=globalThis||window||n||n;var x=Object.assign(Object.create(r.TheGlobal),{"=":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n[0]===n[1]},"<":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])<Number(n[1])},"+":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])+Number(n[1])},"-":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])-Number(n[1])},"*":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])*Number(n[1])},"/":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])/Number(n[1])},isa:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n[0]instanceof n[1]},type:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return typeof n[0]},new:function(){for(var n,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return new((n=e[0]).bind.apply(n,e))},del:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return delete n[0][n[1]]},throw:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];throw n[0]},read:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return JSON.parse(n[0])},js:eval});r.default=h})),r((function(e,r){Object.defineProperty(r,"__esModule",{value:!0}),r.TheGlobal=r.ContinuablePromise=r.EnvWrapper=r.Interpreter=r.findEnv=r.setEnv=r.newEnv=r.isContinuation=r.isApplicable=r.isHalfMacro=r.isMacro=r.isLambda=r.isEnv=r.isBOR=r.isPromiseLike=r.cloneAST=r.VERSION=r.LANGUAGE=void 0,r.LANGUAGE="Continuable-miniMAL-Lisp",r.VERSION="0.4.4",r.cloneAST=function(n,e){if(void 0===e&&(e=new Map),e.has(n))return e.get(n);if("object"==typeof n&&null!==n&&n.constructor===Object)return Object.keys(n).reduce((function(t,a){return t[a]=r.cloneAST(n[a],e),t}),{});if(n instanceof Array){var t=e.set(n,[]).get(n);return t.push.apply(t,n.map((function(n){return r.cloneAST(n,e)}))),t}return n};var t=function(n){throw n};r.isPromiseLike=function(n){return!!n&&("object"==typeof n||"function"==typeof n)&&"function"==typeof n.then};var a=function(n){return"string"==typeof n||t(n+" is not a symbol")},i=function(n){return"string"==typeof n||"symbol"==typeof n||"number"==typeof n||t("String(x) is not a property index")};r.isBOR=function(n,e){return"object"==typeof e&&null!==e&&"string"==typeof e.bor&&e.constructor===Object&&1===Object.keys(e).length&&e.bor in n};var o=function(n){return n instanceof Array},u=function(n){return o(n)||t(n+" is not an array")};r.isEnv=function(n){return n instanceof Array&&"object"==typeof n[0]&&null!==n[0]&&(n[1]instanceof Array||null===n[1])},r.isLambda=function(n){return n instanceof Array&&"=>"===n[0]&&4===n.length&&r.isEnv(n[3])&&n[1]instanceof Array&&n[1].every((function(n){return"string"==typeof n}))},r.isMacro=function(n){return n instanceof Array&&"~"===n[0]&&2===n.length&&r.isApplicable(n[1])},r.isHalfMacro=function(n){return n instanceof Array&&"~~"===n[0]&&2===n.length&&r.isApplicable(n[1])};var l=function(n){return"function"==typeof n};r.isApplicable=function(n){return r.isLambda(n)||l(n)||r.isContinuation(n)||r.isMacro(n)||r.isHalfMacro(n)};var f=function(n){return r.isApplicable(n)||t(n+" is not a applicable")},s=function(n){return r.isHalfMacro(n)||t(n+" is not a half macro")};r.isContinuation=function(n){return"object"==typeof n&&null!==n&&function(n){return"object"==typeof n&&null!==n&&n.parent instanceof Array&&"number"==typeof n.index&&r.isEnv(n.env)&&(null===n.flag||"string"==typeof n.flag)&&"object"==typeof n.handler}(n.current)&&n.stack instanceof Array&&"string"==typeof n.version&&n.version.replace(/\.[^.]+$/,"")===r.VERSION.replace(/\.[^.]+$/,"")};var c=function(n){return r.isContinuation(n)||t(n+" is not a continuation")},p=function(n){return n instanceof Array&&"try"===n[0]&&n[2]instanceof Array&&"string"==typeof n[2][1]&&n[2].length>=3||t(n+" is not a try form or malformed")};r.newEnv=function(n,e,r,t){void 0===t&&(t=!0);for(var a={},i=0;i<e.length;i++){if(t&&"&"===e[i]){a[""+e[i+1]]=r.slice(i);break}a[""+e[i]]=r[i]}return[a,n]},r.setEnv=function(n,e,r){return n[0][""+e]=r},r.findEnv=function(n,e,r){for(var t=n;t;t=t[1]){if(t[0].hasOwnProperty(r))return[t[0][r],!0,!1];if(!t[1]&&e&&r in e&&null!==e[r]&&("object"==typeof e[r]||"function"==typeof e[r]))return[{bor:r},!0,!0]}return[null,!1,!1]};var y=function(n){return n[1]?y(n[1]):n},h=function(n){var e,a=this;if(this.stackMax=1/0,this.base=x,this.env=[{},null],this.dynamicEnv=[{},null],this.loadCore=!0,this.debugCount=0,this.debugMode=!1,this.debugCore=!1,this.debugMax=1/0,this.debugFilter=function(){return!0},this.debug=function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];if(a.debugMode&&a.debugFilter(n)&&(e=e.map((function(n){return n instanceof Array?r.cloneAST(n):n})),console.log.apply(console,v.__spreadArrays([n],e)),a.debugCount++,a.debugCount>a.debugMax))throw new Error("too many debug message!")},this.evalAST=function(n,e,i){void 0===e&&(e=a.env),void 0===i&&(i=a.dynamicEnv);for(var u=[n],l=[{parent:u,index:0,env:e,dynamicEnv:i,flag:null,handler:null}],f=function(n){return l.length>=a.stackMax?t("Stack overflow"):(l.push(n),n)},s=function(){a.debug("Current eval-stack length, eval-stack: ",l.length,l);var n=l.pop(),e=n.parent,i=n.index,u=n.env,s=n.dynamicEnv,c=n.flag,d=n.handler,y=e[i];a.debug("Next evaluating AST node, env, dynamicEnv, flag: ",y,u,s,c);try{if("string"==typeof y){var h=r.findEnv(u,a.base,y),w=h[0],x=h[1];e[i]=x?w:t(y+" not found")}else if(o(y)){var O="string"==typeof y[0]?a.derefBOR(r.findEnv(u,a.base,y[0])[0]):null,j=(r.isMacro(O)?b:r.isHalfMacro(O)||r.isHalfMacro(a.derefBOR(y[0]))&&c?m:"string"==typeof y[0]&&E.hasOwnProperty(y[0])?E[y[0]]:r.isContinuation(y[0])||r.isContinuation(O)?_:g)({node:y,env:u,base:a.base,dynamicEnv:s,flag:c,handler:d,cont:{current:n,stack:l,lang:r.LANGUAGE,version:r.VERSION,info:null},interpreter:a}),S=j.ret,R=j.subevals,C=j.reevals;null==C||C.reverse().forEach((function(n){var r,t,a,o,l,c;return f({parent:null!==(r=n.parent)&&void 0!==r?r:e,index:null!==(t=n.index)&&void 0!==t?t:i,env:null!==(a=n.env)&&void 0!==a?a:u,dynamicEnv:null!==(o=n.dynamicEnv)&&void 0!==o?o:s,flag:null!==(l=n.flag)&&void 0!==l?l:null,handler:null!==(c=n.handler)&&void 0!==c?c:d})})),null==R||R.reverse().forEach((function(n){var r,t,a,o,l,c;return n&&f({parent:null!==(r=n.parent)&&void 0!==r?r:e,index:null!==(t=n.index)&&void 0!==t?t:i,env:null!==(a=n.env)&&void 0!==a?a:u,dynamicEnv:null!==(o=n.dynamicEnv)&&void 0!==o?o:s,flag:null!==(l=n.flag)&&void 0!==l?l:null,handler:null!==(c=n.handler)&&void 0!==c?c:d})})),e[i]=S}}catch(n){if(r.isContinuation(n))throw a.debug("Suspend. Continuation: ",n),n;if(n instanceof A)throw a.debug("Suspend. ContinuablePomise: ",n),n;if(a.debug("Caught an exception. Exception: ",n),!d)throw n;var P=d.parent[d.index];p(P);var M=P[2][1];r.setEnv(d.env,M,n),l.splice.apply(l,v.__spreadArrays([0,l.length],l.filter((function(n){return n.handler!==d})))),f(d)}finally{a.debug("Evaluation Done. Node, env, dynamicEnv: ",e[i],u,s)}};l.length;)s();return a.debug("Evaluatin finished. Result: ",u[0]),u[0]},this.eval=function(n){return a.evalAST(n)},this.rep=function(n){try{return JSON.stringify(a.eval(JSON.parse(n)))}catch(n){if(n instanceof TypeError&&n.message.match(/(circular|cyclic)/i))return;throw n}},this.resume=function(n,e){return a.evalAST(["resume",n,e])},this.evalInBase=function(n){a.evalAST(n,[a.base,null])},this.derefBOR=function(n){return r.isBOR(a.base,n)?a.base[n.bor]:n},this.wrapLambda=function(n){return r.isLambda(n)?function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return a.evalAST(v.__spreadArrays([["`",n]],e))}:n},this.evalAsync=function(n){return new Promise((function(e,r){var t=function(n){try{e(n instanceof A?n.resume():a.eval(n))}catch(n){n instanceof A?n.then((function(){return t(n)}),(function(n){return r(n)})):r(n)}};t(n)}))},"object"==typeof(e=n)&&null!==e&&Object.keys(e).filter((function(n){return void 0===e[n]})).forEach((function(n){return delete e[n]})),Object.assign(this,n),this.loadCore){var i=this.debugMode;this.debugMode=this.debugCore,this.evalInBase(d),this.debugMode=i}};r.Interpreter=h;var g=function(n){var e=n.node,t=n.env,a=n.dynamicEnv,i=n.base,o=n.flag,u=n.interpreter,f=u.derefBOR(e[0]);if(!o&&!r.isApplicable(f)){var s=v.__spreadArrays(e);return{ret:s,reevals:[{flag:"!"}],subevals:s.map((function(n,e){return{parent:s,index:e,env:t}}))}}var c=e.slice(1);if(l(f))try{return{ret:f.apply(void 0,c.map((function(n){return u.wrapLambda(u.derefBOR(n))})))}}catch(y){if(r.isContinuation(y))throw"Javascript function can not throw any continuation.";throw y}else{if(!r.isLambda(f))throw String(f)+" is not applicable";var d=f[1],p=f[2],y=f[3];if("function"!=typeof p)return{ret:p,reevals:[{env:r.newEnv(y,d,c)}]};try{return{ret:p(new w(r.newEnv(y,d,c),a,t,i),u)}}catch(y){if(r.isContinuation(y))throw"Javascript function can not throw any continuation.";throw y}}},b=function(n){var e=n.node,i=n.env,o=n.base,u=n.interpreter;a(e[0]);var l,f=u.derefBOR(r.findEnv(i,o,e[0])[0]);return l=f,r.isMacro(l)||t(l+" is not a macro"),{ret:v.__spreadArrays([f[1]],e.slice(1)),reevals:[{flag:"!"},{flag:null}]}},m=function(n){var e=n.node,t=n.env,i=n.base,o=n.flag,u=n.interpreter;if(o){l=u.derefBOR(e[0]);return s(l),{ret:v.__spreadArrays([l[1]],e.slice(1)),reevals:[{flag:"!"},{flag:null}]}}a(e[0]);var l=u.derefBOR(r.findEnv(t,i,e[0])[0]);s(l);var f=v.__spreadArrays(e);return{ret:f,subevals:f.map((function(n,e){return{parent:f,index:e}})),reevals:[{flag:"!"}]}},_=function(n){var e,t=n.node,a=n.flag,i=n.cont,o=t[0];if(a||r.isApplicable(o)){var u=t.slice(1);c(o);var l=o.current,f=l.parent;f[l.index]=null!==(e=u[0])&&void 0!==e?e:null;var s=o.stack.length>0?o.stack[0].parent:f;if(1!==s.length)throw"Illeal root of continuation";var d=o.stack.map((function(n){return n.parent===s&&(n.parent=i.current.parent,n.index=i.current.index),n}));return{ret:s[0],subevals:d.reverse()}}var p=v.__spreadArrays(t);return{ret:p,reevals:[{flag:"!"}],subevals:p.map((function(n,e){return{parent:p,index:e}}))}},E={"`":function(n){return{ret:n.node[1]}},eval:function(n){var e=n.node;if(n.flag)return{ret:e[1],reevals:[{flag:null}]};var r=v.__spreadArrays(e);return{ret:r,reevals:[{flag:"!"}],subevals:[{parent:r,index:1}]}},def:function(n){var e=n.node,t=n.env;if(n.flag){var i=e[1],o=e[2],u=void 0===o?null:o;return a(i),{ret:r.setEnv(t,i,u)}}var l=v.__spreadArrays(e);return{ret:l,reevals:[{flag:"!"}],subevals:[{parent:l,index:2}]}},defdynamic:function(n){var e=n.node,t=n.dynamicEnv;if(n.flag){var i=e[1],o=e[2],u=void 0===o?null:o;return a(i),r.setEnv(y(t),i,u),{ret:u}}var l=v.__spreadArrays(e);return{ret:l,reevals:[{flag:"!"}],subevals:[{parent:l,index:2}]}},"~":function(n){var e=n.node,r=n.flag,t=v.__spreadArrays(e);return r?(f(t[1]),{ret:t}):{ret:t,reevals:[{flag:"!"}],subevals:[{parent:t,index:1}]}},"~~":function(n){var e=n.node,r=n.flag,t=v.__spreadArrays(e);return r?(f(t[1]),{ret:t}):{ret:t,reevals:[{flag:"!"}],subevals:[{parent:t,index:1}]}},".-":function(n){var e=n.node,r=(n.base,n.flag),t=n.interpreter;if(r){var a=t.derefBOR(e[1]);if(null==a)throw"Can't read/set property of null or undefined.";var o=e.map((function(n){return t.derefBOR(n)})),u=o[2],l=o[3];return i(u),{ret:3===e.length?a[u]:a[u]=l}}var f=v.__spreadArrays(e);return{ret:f,reevals:[{flag:"!"}],subevals:f.map((function(n,e){return e>=1&&{parent:f,index:e}}))}},".":function(n){var e=n.node,t=(n.base,n.flag),a=n.interpreter;if(!t){var o=v.__spreadArrays(e);return{ret:o,reevals:[{flag:"!"}],subevals:o.map((function(n,e){return e>=1&&{parent:o,index:e}}))}}var u=a.derefBOR(e[1]);if(null==u)throw"Can't call method of null or undefined.";var l=e[2],s=e.slice(3);if(i(l),"function"!=typeof u[l])return f(u[l]),{ret:v.__spreadArrays([u[l]],s),reevals:[{flag:"!"}]};try{return{ret:u[l].apply(u,s.map((function(n){return a.wrapLambda(a.derefBOR(n))})))}}catch(n){if(r.isContinuation(n))throw"Javascript methods can not throw any continuation.";throw n}},oget:function(n){var e=n.node,r=(n.base,n.flag),t=n.interpreter;if(r){var a=t.derefBOR(e[1]);if(null==a)throw"Can't read property of null or undefined.";var o=e[2];return i(o),{ret:a[o]}}var u=v.__spreadArrays(e);return{ret:u,reevals:[{flag:"!"}],subevals:u.map((function(n,e){return e>=1&&{parent:u,index:e}}))}},oset:function(n){var e=n.node,r=(n.base,n.flag),t=n.interpreter;if(r){var a=t.derefBOR(e[1]);if(null==a)throw"Can't set property of null or undefined.";var o=e[2],u=e[3];return i(o),{ret:a[o]=u}}var l=v.__spreadArrays(e);return{ret:l,reevals:[{flag:"!"}],subevals:l.map((function(n,e){return e>=1&&{parent:l,index:e}}))}},try:function(n){var e=n.node,t=n.env,a=n.dynamicEnv,i=n.flag,o=n.cont,u=n.handler;if(p(e),i){if("!"===i)return{ret:e[1]};if("!!"===i)return{ret:e[2][2],reevals:[{}]};throw"Illegal status for try-catch."}var l={parent:o.current.parent,index:o.current.index,env:r.newEnv(t,[],[]),dynamicEnv:a,flag:"!!",handler:u},f=v.__spreadArrays(e);return{ret:f,reevals:[{flag:"!",handler:l}],subevals:[{parent:f,index:1,handler:l}]}},fn:function(n){var e,r=n.node,a=n.env;return(e=r)instanceof Array&&"fn"===e[0]&&3===e.length&&e[1]instanceof Array&&e[1].every((function(n){return"string"==typeof n}))||t(e+" is not a fn form or malformed"),{ret:["=>",r[1],r[2],a]}},map:function(n){var e=n.node;if(n.flag){var r=e[1],t=e[2];u(t);var a=t.map((function(n,e){return[r,t[e]]}));return{ret:a,subevals:a.map((function(n,e){return{parent:a,index:e,flag:"!"}}))}}var i=v.__spreadArrays(e);return{ret:i,reevals:[{flag:"!"}],subevals:i.map((function(n,e){return e>=1&&{parent:i,index:e}}))}},apply:function(n){var e=n.node;if(n.flag){var r=e[1],t=e.slice(2),a=t.pop();return u(a),t.push.apply(t,a),{ret:v.__spreadArrays([r],t),reevals:[{flag:"!"}]}}var i=v.__spreadArrays(e);return{ret:i,reevals:[{flag:"!"}],subevals:i.map((function(n,e){return e>=1&&{parent:i,index:e}}))}},let:function(n){var e,a=n.node,i=n.env;(e=a)instanceof Array&&"let"===e[0]&&e[1]instanceof Array&&e.length>=3||t(e+" is not a let form or malformed");var o=a[1],u=a[2];o.length%2==1&&o.push(null);var l=o.reduce((function(n,e,r){return r%2?n:n.concat([[o[r],o[r+1]]])}),[]);return{ret:v.__spreadArrays(["do"],l.map((function(n){return["def",n[0],n[1]]})),[u]),reevals:[{env:r.newEnv(i,[],[])}]}},"dynamic-let":function(n){var e,a=n.node,i=n.dynamicEnv,o=n.flag;if((e=a)instanceof Array&&"dynamic-let"===e[0]&&e[1]instanceof Array&&e.length>=3||t(e+" is not a let form or malformed"),o){var u=a[1];d=a[2];u.length%2==1&&u.push(null);var l=u.reduce((function(n,e,r){return r%2?n:n.concat([[u[r],u[r+1]]])}),[]),f=r.newEnv(i,[],[]);return l.forEach((function(n){var e=n[0],t=n[1];return r.setEnv(f,String(e),t)})),{ret:d,reevals:[{dynamicEnv:f}]}}var s=a[0],c=a[1],d=a[2],p=v.__spreadArrays(c);return{ret:[s,p,d],subevals:p.map((function(n,e){return e})).filter((function(n){return n%2==1})).map((function(n){return{parent:p,index:n}})),reevals:[{flag:"!"}]}},do:function(n){var e=n.node.slice(1),r=e.slice(-1)[0];return{ret:void 0===r?null:r,reevals:[{flag:null}],subevals:e.slice(0,-1).map((function(n){return{parent:[n],index:0}}))}},if:function(n){var e=n.node;if(n.flag)return{ret:e[1]?e[2]:e[3],reevals:[{flag:null}]};var r=v.__spreadArrays(e);return{ret:r,reevals:[{flag:"!"}],subevals:[{parent:r,index:1}]}},suspend:function(n){var e,r=n.node,t=n.flag,a=n.cont;if(t){var i=r.slice(1);throw a.info=null!==(e=i[0])&&void 0!==e?e:null,a}var o=v.__spreadArrays(r);return{ret:o,reevals:[{flag:"!"}],subevals:[{parent:o,index:1}]}},resume:function(n){var e=n.node,r=(n.flag,e[1]),t=e.slice(2);return c(r),{ret:v.__spreadArrays([r],t),reevals:[{flag:"!"}]}},dynamic:function(n){var e=n.node,i=n.dynamicEnv,o=e[1];a(o);var u=r.findEnv(i,null,o),l=u[0];return{ret:u[1]?l:t("dynamic variable "+o+" not found")}},await:function(n){var e=n.node,r=n.flag,t=n.cont,a=n.interpreter;if(r){var i=e.slice(1);throw new A(a,0===i.length?null:1===i.length?i[0]:Promise.all(i),t)}var o=v.__spreadArrays(e);return{ret:o,reevals:[{flag:"!"}],subevals:[{parent:o,index:1}]}}},w=function(n,e,t,a){var i=this;this.get=function(n){return r.findEnv(i.env,i.base,n)[0]},this.has=function(n){return r.findEnv(i.env,i.base,n)[1]},this.set=function(n,e){return r.setEnv(i.env,n,e)},this.dynamicGet=function(n){return r.findEnv(i.dynamicEnv,null,n)[0]},this.dynamicHas=function(n){return r.findEnv(i.dynamicEnv,null,n)[1]},this.dynamicSet=function(n,e){return r.setEnv(y(i.dynamicEnv),n,e)},this.dynamicSetLocal=function(n,e){return r.setEnv(i.dynamicEnv,n,e)},this.callerGet=function(n){return r.findEnv(i.callerEnv,i.base,n)[0]},this.callerHas=function(n){return r.findEnv(i.callerEnv,i.base,n)[1]},this.env=n,this.dynamicEnv=e,this.callerEnv=t,this.base=a};r.EnvWrapper=w;var A=function(){function n(n,e,t){var a=this;this.status="pending",this.promise=new Promise((function(n,e){a.resolve=n,a.reject=e})),this.interpreter=n,this.coninuation=t,r.isPromiseLike(e)?e.then((function(n){a.resolvedValue=n,a.status="fulfilled",a.resolve()}),(function(n){a.rejectedReason=n,a.status="rejected",a.reject(n)})):(this.resolvedValue=e,this.status="fulfilled",this.resolve())}return n.prototype.isFulfilled=function(){return"fulfilled"===this.status},n.prototype.isRejected=function(){return"rejected"===this.status},n.prototype.isPending=function(){return"pending"===this.status},n.prototype.reason=function(){if(!this.isRejected())throw new Error("The promise is not rejected yet.");return this.rejectedReason},n.prototype.resume=function(){if(!this.isFulfilled())throw new Error("The promise is not fulfilled yet.");return this.interpreter.resume(this.coninuation,this.resolvedValue)},n.prototype.then=function(n,e){return this.promise.then(n,e)},n.prototype.catch=function(n){return this.promise.catch(n)},n}();r.ContinuablePromise=A,r.TheGlobal=globalThis||window||n||n;var x=Object.assign(Object.create(r.TheGlobal),{"=":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n[0]===n[1]},"<":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])<Number(n[1])},"+":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])+Number(n[1])},"-":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])-Number(n[1])},"*":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])*Number(n[1])},"/":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])/Number(n[1])},isa:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n[0]instanceof n[1]},type:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return typeof n[0]},new:function(){for(var n,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return new((n=e[0]).bind.apply(n,e))},del:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return delete n[0][n[1]]},throw:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];throw n[0]},read:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return JSON.parse(n[0])},js:eval});r.default=h}))),y=e(r((function(n,e){Object.defineProperty(e,"__esModule",{value:!0}),v.__exportStar(p,e)})));exports.default=y;
