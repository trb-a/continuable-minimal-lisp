/*!
  ContinuableMinimalLisp.js v0.4.4
  https://github.com/trb-a/continuable-minimal-lisp
  Released under the MIT License.
  Note: Language specification's license is unconfirmed.
*/
"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function n(){for(var n=0,e=0,r=arguments.length;e<r;e++)n+=arguments[e].length;var t=Array(n),a=0;for(e=0;e<r;e++)for(var i=arguments[e],o=0,u=i.length;o<u;o++,a++)t[a]=i[o];return t}Object.defineProperty(exports,"__esModule",{value:!0});var e=function(n,r){if(void 0===r&&(r=new Map),r.has(n))return r.get(n);if("object"==typeof n&&null!==n&&n.constructor===Object)return Object.keys(n).reduce((function(t,a){return t[a]=e(n[a],r),t}),{});if(n instanceof Array){var t=r.set(n,[]).get(n);return t.push.apply(t,n.map((function(n){return e(n,r)}))),t}return n},r=function(n){throw n},t=function(n){return!!n&&("object"==typeof n||"function"==typeof n)&&"function"==typeof n.then},a=function(n){return"string"==typeof n||r(n+" is not a symbol")},i=function(n){return"string"==typeof n||"symbol"==typeof n||"number"==typeof n||r("String(x) is not a property index")},o=function(n,e){return"object"==typeof e&&null!==e&&"string"==typeof e.bor&&e.constructor===Object&&1===Object.keys(e).length&&e.bor in n},u=function(n){return n instanceof Array},l=function(n){return u(n)||r(n+" is not an array")},f=function(n){return n instanceof Array&&"object"==typeof n[0]&&null!==n[0]&&(n[1]instanceof Array||null===n[1])},s=function(n){return n instanceof Array&&"=>"===n[0]&&4===n.length&&f(n[3])&&n[1]instanceof Array&&n[1].every((function(n){return"string"==typeof n}))},c=function(n){return n instanceof Array&&"~"===n[0]&&2===n.length&&p(n[1])},v=function(n){return n instanceof Array&&"~~"===n[0]&&2===n.length&&p(n[1])},d=function(n){return"function"==typeof n},p=function(n){return s(n)||d(n)||y(n)||c(n)||v(n)},h=function(n){return p(n)||r(n+" is not a applicable")},g=function(n){return v(n)||r(n+" is not a half macro")},y=function(n){return"object"==typeof n&&null!==n&&function(n){return"object"==typeof n&&null!==n&&n.parent instanceof Array&&"number"==typeof n.index&&f(n.env)&&(null===n.flag||"string"==typeof n.flag)&&"object"==typeof n.handler}(n.current)&&n.stack instanceof Array&&"string"==typeof n.version&&n.version.replace(/\.[^.]+$/,"")==="0.4.4".replace(/\.[^.]+$/,"")},b=function(n){return y(n)||r(n+" is not a continuation")},m=function(n){return n instanceof Array&&"try"===n[0]&&n[2]instanceof Array&&"string"==typeof n[2][1]&&n[2].length>=3||r(n+" is not a try form or malformed")},x=function(n,e,r,t){void 0===t&&(t=!0);for(var a={},i=0;i<e.length;i++){if(t&&"&"===e[i]){a[""+e[i+1]]=r.slice(i);break}a[""+e[i]]=r[i]}return[a,n]},w=function(n,e,r){return n[0][""+e]=r},E=function(n,e,r){for(var t=n;t;t=t[1]){if(t[0].hasOwnProperty(r))return[t[0][r],!0,!1];if(!t[1]&&e&&r in e&&null!==e[r]&&("object"==typeof e[r]||"function"==typeof e[r]))return[{bor:r},!0,!0]}return[null,!1,!1]},A=function(n){return n[1]?A(n[1]):n},O=function(t){var a,i=this;if(this.stackMax=1/0,this.base=T,this.env=[{},null],this.dynamicEnv=[{},null],this.loadCore=!0,this.debugCount=0,this.debugMode=!1,this.debugCore=!1,this.debugMax=1/0,this.debugFilter=function(){return!0},this.debug=function(r){for(var t=[],a=1;a<arguments.length;a++)t[a-1]=arguments[a];if(i.debugMode&&i.debugFilter(r)&&(t=t.map((function(n){return n instanceof Array?e(n):n})),console.log.apply(console,n([r],t)),i.debugCount++,i.debugCount>i.debugMax))throw new Error("too many debug message!")},this.evalAST=function(e,t,a){void 0===t&&(t=i.env),void 0===a&&(a=i.dynamicEnv);for(var o=[e],l=[{parent:o,index:0,env:t,dynamicEnv:a,flag:null,handler:null}],f=function(n){return l.length>=i.stackMax?r("Stack overflow"):(l.push(n),n)},s=function(){i.debug("Current eval-stack length, eval-stack: ",l.length,l);var e=l.pop(),t=e.parent,a=e.index,o=e.env,s=e.dynamicEnv,d=e.flag,p=e.handler,h=t[a];i.debug("Next evaluating AST node, env, dynamicEnv, flag: ",h,o,s,d);try{if("string"==typeof h){var g=E(o,i.base,h),b=g[0],x=g[1];t[a]=x?b:r(h+" not found")}else if(u(h)){var A="string"==typeof h[0]?i.derefBOR(E(o,i.base,h[0])[0]):null,O=(c(A)?R:v(A)||v(i.derefBOR(h[0]))&&d?C:"string"==typeof h[0]&&B.hasOwnProperty(h[0])?B[h[0]]:y(h[0])||y(A)?S:j)({node:h,env:o,base:i.base,dynamicEnv:s,flag:d,handler:p,cont:{current:e,stack:l,lang:"Continuable-miniMAL-Lisp",version:"0.4.4",info:null},interpreter:i}),N=O.ret,M=O.subevals,T=O.reevals;null==T||T.reverse().forEach((function(n){var e,r,i,u,l,c;return f({parent:null!==(e=n.parent)&&void 0!==e?e:t,index:null!==(r=n.index)&&void 0!==r?r:a,env:null!==(i=n.env)&&void 0!==i?i:o,dynamicEnv:null!==(u=n.dynamicEnv)&&void 0!==u?u:s,flag:null!==(l=n.flag)&&void 0!==l?l:null,handler:null!==(c=n.handler)&&void 0!==c?c:p})})),null==M||M.reverse().forEach((function(n){var e,r,i,u,l,c;return n&&f({parent:null!==(e=n.parent)&&void 0!==e?e:t,index:null!==(r=n.index)&&void 0!==r?r:a,env:null!==(i=n.env)&&void 0!==i?i:o,dynamicEnv:null!==(u=n.dynamicEnv)&&void 0!==u?u:s,flag:null!==(l=n.flag)&&void 0!==l?l:null,handler:null!==(c=n.handler)&&void 0!==c?c:p})})),t[a]=N}}catch(e){if(y(e))throw i.debug("Suspend. Continuation: ",e),e;if(e instanceof k)throw i.debug("Suspend. ContinuablePomise: ",e),e;if(i.debug("Caught an exception. Exception: ",e),!p)throw e;var L=p.parent[p.index];m(L);var P=L[2][1];w(p.env,P,e),l.splice.apply(l,n([0,l.length],l.filter((function(n){return n.handler!==p})))),f(p)}finally{i.debug("Evaluation Done. Node, env, dynamicEnv: ",t[a],o,s)}};l.length;)s();return i.debug("Evaluatin finished. Result: ",o[0]),o[0]},this.eval=function(n){return i.evalAST(n)},this.rep=function(n){try{return JSON.stringify(i.eval(JSON.parse(n)))}catch(n){if(n instanceof TypeError&&n.message.match(/(circular|cyclic)/i))return;throw n}},this.resume=function(n,e){return i.evalAST(["resume",n,e])},this.evalInBase=function(n){i.evalAST(n,[i.base,null])},this.derefBOR=function(n){return o(i.base,n)?i.base[n.bor]:n},this.wrapLambda=function(e){return s(e)?function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return i.evalAST(n([["`",e]],r))}:e},this.evalAsync=function(n){return new Promise((function(e,r){var t=function(n){try{e(n instanceof k?n.resume():i.eval(n))}catch(n){n instanceof k?n.then((function(){return t(n)}),(function(n){return r(n)})):r(n)}};t(n)}))},"object"==typeof(a=t)&&null!==a&&Object.keys(a).filter((function(n){return void 0===a[n]})).forEach((function(n){return delete a[n]})),Object.assign(this,t),this.loadCore){var l=this.debugMode;this.debugMode=this.debugCore,this.evalInBase(require("./core.json")),this.debugMode=l}},j=function(e){var r=e.node,t=e.env,a=e.dynamicEnv,i=e.base,o=e.flag,u=e.interpreter,l=u.derefBOR(r[0]);if(!o&&!p(l)){var f=n(r);return{ret:f,reevals:[{flag:"!"}],subevals:f.map((function(n,e){return{parent:f,index:e,env:t}}))}}var c=r.slice(1);if(d(l))try{return{ret:l.apply(void 0,c.map((function(n){return u.wrapLambda(u.derefBOR(n))})))}}catch(g){if(y(g))throw"Javascript function can not throw any continuation.";throw g}else{if(!s(l))throw String(l)+" is not applicable";var v=l[1],h=l[2],g=l[3];if("function"!=typeof h)return{ret:h,reevals:[{env:x(g,v,c)}]};try{return{ret:h(new N(x(g,v,c),a,t,i),u)}}catch(g){if(y(g))throw"Javascript function can not throw any continuation.";throw g}}},R=function(e){var t=e.node,i=e.env,o=e.base,u=e.interpreter;a(t[0]);var l,f=u.derefBOR(E(i,o,t[0])[0]);return c(l=f)||r(l+" is not a macro"),{ret:n([f[1]],t.slice(1)),reevals:[{flag:"!"},{flag:null}]}},C=function(e){var r=e.node,t=e.env,i=e.base,o=e.flag,u=e.interpreter;if(o){l=u.derefBOR(r[0]);return g(l),{ret:n([l[1]],r.slice(1)),reevals:[{flag:"!"},{flag:null}]}}a(r[0]);var l=u.derefBOR(E(t,i,r[0])[0]);g(l);var f=n(r);return{ret:f,subevals:f.map((function(n,e){return{parent:f,index:e}})),reevals:[{flag:"!"}]}},S=function(e){var r,t=e.node,a=e.flag,i=e.cont,o=t[0];if(a||p(o)){var u=t.slice(1);b(o);var l=o.current,f=l.parent;f[l.index]=null!==(r=u[0])&&void 0!==r?r:null;var s=o.stack.length>0?o.stack[0].parent:f;if(1!==s.length)throw"Illeal root of continuation";var c=o.stack.map((function(n){return n.parent===s&&(n.parent=i.current.parent,n.index=i.current.index),n}));return{ret:s[0],subevals:c.reverse()}}var v=n(t);return{ret:v,reevals:[{flag:"!"}],subevals:v.map((function(n,e){return{parent:v,index:e}}))}},B={"`":function(n){return{ret:n.node[1]}},eval:function(e){var r=e.node;if(e.flag)return{ret:r[1],reevals:[{flag:null}]};var t=n(r);return{ret:t,reevals:[{flag:"!"}],subevals:[{parent:t,index:1}]}},def:function(e){var r=e.node,t=e.env;if(e.flag){var i=r[1],o=r[2],u=void 0===o?null:o;return a(i),{ret:w(t,i,u)}}var l=n(r);return{ret:l,reevals:[{flag:"!"}],subevals:[{parent:l,index:2}]}},defdynamic:function(e){var r=e.node,t=e.dynamicEnv;if(e.flag){var i=r[1],o=r[2],u=void 0===o?null:o;return a(i),w(A(t),i,u),{ret:u}}var l=n(r);return{ret:l,reevals:[{flag:"!"}],subevals:[{parent:l,index:2}]}},"~":function(e){var r=e.node,t=e.flag,a=n(r);return t?(h(a[1]),{ret:a}):{ret:a,reevals:[{flag:"!"}],subevals:[{parent:a,index:1}]}},"~~":function(e){var r=e.node,t=e.flag,a=n(r);return t?(h(a[1]),{ret:a}):{ret:a,reevals:[{flag:"!"}],subevals:[{parent:a,index:1}]}},".-":function(e){var r=e.node,t=(e.base,e.flag),a=e.interpreter;if(t){var o=a.derefBOR(r[1]);if(null==o)throw"Can't read/set property of null or undefined.";var u=r.map((function(n){return a.derefBOR(n)})),l=u[2],f=u[3];return i(l),{ret:3===r.length?o[l]:o[l]=f}}var s=n(r);return{ret:s,reevals:[{flag:"!"}],subevals:s.map((function(n,e){return e>=1&&{parent:s,index:e}}))}},".":function(e){var r=e.node,t=(e.base,e.flag),a=e.interpreter;if(!t){var o=n(r);return{ret:o,reevals:[{flag:"!"}],subevals:o.map((function(n,e){return e>=1&&{parent:o,index:e}}))}}var u=a.derefBOR(r[1]);if(null==u)throw"Can't call method of null or undefined.";var l=r[2],f=r.slice(3);if(i(l),"function"!=typeof u[l])return h(u[l]),{ret:n([u[l]],f),reevals:[{flag:"!"}]};try{return{ret:u[l].apply(u,f.map((function(n){return a.wrapLambda(a.derefBOR(n))})))}}catch(n){if(y(n))throw"Javascript methods can not throw any continuation.";throw n}},oget:function(e){var r=e.node,t=(e.base,e.flag),a=e.interpreter;if(t){var o=a.derefBOR(r[1]);if(null==o)throw"Can't read property of null or undefined.";var u=r[2];return i(u),{ret:o[u]}}var l=n(r);return{ret:l,reevals:[{flag:"!"}],subevals:l.map((function(n,e){return e>=1&&{parent:l,index:e}}))}},oset:function(e){var r=e.node,t=(e.base,e.flag),a=e.interpreter;if(t){var o=a.derefBOR(r[1]);if(null==o)throw"Can't set property of null or undefined.";var u=r[2],l=r[3];return i(u),{ret:o[u]=l}}var f=n(r);return{ret:f,reevals:[{flag:"!"}],subevals:f.map((function(n,e){return e>=1&&{parent:f,index:e}}))}},try:function(e){var r=e.node,t=e.env,a=e.dynamicEnv,i=e.flag,o=e.cont,u=e.handler;if(m(r),i){if("!"===i)return{ret:r[1]};if("!!"===i)return{ret:r[2][2],reevals:[{}]};throw"Illegal status for try-catch."}var l={parent:o.current.parent,index:o.current.index,env:x(t,[],[]),dynamicEnv:a,flag:"!!",handler:u},f=n(r);return{ret:f,reevals:[{flag:"!",handler:l}],subevals:[{parent:f,index:1,handler:l}]}},fn:function(n){var e,t=n.node,a=n.env;return(e=t)instanceof Array&&"fn"===e[0]&&3===e.length&&e[1]instanceof Array&&e[1].every((function(n){return"string"==typeof n}))||r(e+" is not a fn form or malformed"),{ret:["=>",t[1],t[2],a]}},map:function(e){var r=e.node;if(e.flag){var t=r[1],a=r[2];l(a);var i=a.map((function(n,e){return[t,a[e]]}));return{ret:i,subevals:i.map((function(n,e){return{parent:i,index:e,flag:"!"}}))}}var o=n(r);return{ret:o,reevals:[{flag:"!"}],subevals:o.map((function(n,e){return e>=1&&{parent:o,index:e}}))}},apply:function(e){var r=e.node;if(e.flag){var t=r[1],a=r.slice(2),i=a.pop();return l(i),a.push.apply(a,i),{ret:n([t],a),reevals:[{flag:"!"}]}}var o=n(r);return{ret:o,reevals:[{flag:"!"}],subevals:o.map((function(n,e){return e>=1&&{parent:o,index:e}}))}},let:function(e){var t,a=e.node,i=e.env;(t=a)instanceof Array&&"let"===t[0]&&t[1]instanceof Array&&t.length>=3||r(t+" is not a let form or malformed");var o=a[1],u=a[2];return o.length%2==1&&o.push(null),{ret:n(["do"],o.reduce((function(n,e,r){return r%2?n:n.concat([[o[r],o[r+1]]])}),[]).map((function(n){return["def",n[0],n[1]]})),[u]),reevals:[{env:x(i,[],[])}]}},"dynamic-let":function(e){var t,a=e.node,i=e.dynamicEnv,o=e.flag;if((t=a)instanceof Array&&"dynamic-let"===t[0]&&t[1]instanceof Array&&t.length>=3||r(t+" is not a let form or malformed"),o){var u=a[1];v=a[2];u.length%2==1&&u.push(null);var l=u.reduce((function(n,e,r){return r%2?n:n.concat([[u[r],u[r+1]]])}),[]),f=x(i,[],[]);return l.forEach((function(n){var e=n[0],r=n[1];return w(f,String(e),r)})),{ret:v,reevals:[{dynamicEnv:f}]}}var s=a[0],c=a[1],v=a[2],d=n(c);return{ret:[s,d,v],subevals:d.map((function(n,e){return e})).filter((function(n){return n%2==1})).map((function(n){return{parent:d,index:n}})),reevals:[{flag:"!"}]}},do:function(n){var e=n.node.slice(1),r=e.slice(-1)[0];return{ret:void 0===r?null:r,reevals:[{flag:null}],subevals:e.slice(0,-1).map((function(n){return{parent:[n],index:0}}))}},if:function(e){var r=e.node;if(e.flag)return{ret:r[1]?r[2]:r[3],reevals:[{flag:null}]};var t=n(r);return{ret:t,reevals:[{flag:"!"}],subevals:[{parent:t,index:1}]}},suspend:function(e){var r,t=e.node,a=e.flag,i=e.cont;if(a){var o=t.slice(1);throw i.info=null!==(r=o[0])&&void 0!==r?r:null,i}var u=n(t);return{ret:u,reevals:[{flag:"!"}],subevals:[{parent:u,index:1}]}},resume:function(e){var r=e.node,t=(e.flag,r[1]),a=r.slice(2);return b(t),{ret:n([t],a),reevals:[{flag:"!"}]}},dynamic:function(n){var e=n.node,t=n.dynamicEnv,i=e[1];a(i);var o=E(t,null,i),u=o[0];return{ret:o[1]?u:r("dynamic variable "+i+" not found")}},await:function(e){var r=e.node,t=e.flag,a=e.cont,i=e.interpreter;if(t){var o=r.slice(1);throw new k(i,0===o.length?null:1===o.length?o[0]:Promise.all(o),a)}var u=n(r);return{ret:u,reevals:[{flag:"!"}],subevals:[{parent:u,index:1}]}}},N=function(n,e,r,t){var a=this;this.get=function(n){return E(a.env,a.base,n)[0]},this.has=function(n){return E(a.env,a.base,n)[1]},this.set=function(n,e){return w(a.env,n,e)},this.dynamicGet=function(n){return E(a.dynamicEnv,null,n)[0]},this.dynamicHas=function(n){return E(a.dynamicEnv,null,n)[1]},this.dynamicSet=function(n,e){return w(A(a.dynamicEnv),n,e)},this.dynamicSetLocal=function(n,e){return w(a.dynamicEnv,n,e)},this.callerGet=function(n){return E(a.callerEnv,a.base,n)[0]},this.callerHas=function(n){return E(a.callerEnv,a.base,n)[1]},this.env=n,this.dynamicEnv=e,this.callerEnv=r,this.base=t},k=function(){function n(n,e,r){var a=this;this.status="pending",this.promise=new Promise((function(n,e){a.resolve=n,a.reject=e})),this.interpreter=n,this.coninuation=r,t(e)?e.then((function(n){a.resolvedValue=n,a.status="fulfilled",a.resolve()}),(function(n){a.rejectedReason=n,a.status="rejected",a.reject(n)})):(this.resolvedValue=e,this.status="fulfilled",this.resolve())}return n.prototype.isFulfilled=function(){return"fulfilled"===this.status},n.prototype.isRejected=function(){return"rejected"===this.status},n.prototype.isPending=function(){return"pending"===this.status},n.prototype.reason=function(){if(!this.isRejected())throw new Error("The promise is not rejected yet.");return this.rejectedReason},n.prototype.resume=function(){if(!this.isFulfilled())throw new Error("The promise is not fulfilled yet.");return this.interpreter.resume(this.coninuation,this.resolvedValue)},n.prototype.then=function(n,e){return this.promise.then(n,e)},n.prototype.catch=function(n){return this.promise.catch(n)},n}(),M=globalThis||window||global||this,T=Object.assign(Object.create(M),{"=":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n[0]===n[1]},"<":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])<Number(n[1])},"+":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])+Number(n[1])},"-":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])-Number(n[1])},"*":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])*Number(n[1])},"/":function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Number(n[0])/Number(n[1])},isa:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n[0]instanceof n[1]},type:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return typeof n[0]},new:function(){for(var n,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return new((n=e[0]).bind.apply(n,e))},del:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return delete n[0][n[1]]},throw:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];throw n[0]},read:function(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return JSON.parse(n[0])},js:eval});exports.ContinuablePromise=k,exports.EnvWrapper=N,exports.Interpreter=O,exports.LANGUAGE="Continuable-miniMAL-Lisp",exports.TheGlobal=M,exports.VERSION="0.4.4",exports.cloneAST=e,exports.findEnv=E,exports.isApplicable=p,exports.isBOR=o,exports.isContinuation=y,exports.isEnv=f,exports.isHalfMacro=v,exports.isLambda=s,exports.isMacro=c,exports.isPromiseLike=t,exports.newEnv=x,exports.setEnv=w;
